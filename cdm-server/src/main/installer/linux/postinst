#!/bin/sh
# postinst script for cdmserver
#
# see: dh_installdeb(1)

set -e

#
#variables
#
CDM_HOME="/opt/cdmserver/"
CDM_LIBRARY=$CDM_HOME".cdmLibrary"
CDM_LOG="/var/log/cdmserver/"
bindir="/etc/init.d/"
TMP="/usr/bin/"

SERVERSCRIPT="cdmserver"
SERVERJAR="cdm-server.jar"
SERVERCONF="datasources.xml"
PROPERTIES="cdmserver.properties"

CDM_USER=cdmuser
CDM_GROUP=cdmgroup
CDM_USER_HOME=/opt/cdmserver/
#CDM_USER_HOME=/root/cdmserver/

#
#functions
#
userExist(){
    grep $1 /etc/passwd > /dev/null
    [ $? -eq 0 ] && return $TRUE || return $FALSE
}

groupExist(){
    grep $1 /etc/group > /dev/null
    [ $? -eq 0 ] && return $TRUE || return $FALSE
}


# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

case "$1" in
    configure)

    #
    # adding the user
    # if the user already exist will be deleted
    #
    if ( userExist $CDM_USER )
    then
    echo USER ALREADY EXITS!!!!
    userdel $CDM_USER
    fi
   
    #
    # adding the group
    # if the group already exist will be deleted
    #
    if ( groupExist $CDM_GROUP  )
    then
        echo GROUP ALREADY EXISTS!!!!
        groupdel $CDM_GROUP
    fi
    groupadd $CDM_GROUP

    useradd -G cdmgroup -d $CDM_USER_HOME $CDM_USER

    #installing the script
    cp $TMP$SERVERSCRIPT $bindir
    chmod 755 $bindir$SERVERSCRIPT
    chown $CDM_USER:$CDM_GROUP $bindir$SERVERSCRIPT
    update-rc.d $SERVERSCRIPT defaults 98 02

    #creating the directories
    if [ ! -d $CDM_HOME ]; then
        mkdir -p $CDM_HOME
    fi
    if [ ! -d $CDM_LIBRARY ]; then
        mkdir -p $CDM_LIBRARY
    fi
    if [ ! -d $CDM_LOG ]; then
        mkdir -p $CDM_LOG
    fi

    #installing the server and the configfile
    cp $TMP$SERVERCONF $CDM_LIBRARY
    cp $TMP$SERVERJAR $CDM_HOME
    #cp $TMP$PROPERTIES $CDM_LIBRARY
    #mkdir -p /root/.cdmLibrary
    #cp $TMP$SERVERCONF /root/.cdmLibrary/
    cp $TMP$SERVERCONF $CDM_LIBRARY

    #starting the script
    $bindir$SERVERSCRIPT start


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


